{% unless grid_item_width %}
  {% assign grid_item_width = 'small-12 medium-3 large-3 columns' %}
{% endunless %}

{% assign on_sale = false %}
{% if product.compare_at_price > product.price %}
  {% assign on_sale = true %}
  {%- assign discount_percentage = product.compare_at_price | minus: product.price | times: 100 | divided_by: product.compare_at_price -%}
{% endif %}

{% assign sold_out = true %}
{% if product.available %}
  {% assign sold_out = false %}
{% endif %}

{%- comment -%} VALIDACIÓN: Mostrar botones SOLO en colecciones {%- endcomment -%}
{% assign is_collection_page = false %}
{% if template == 'collection' or template.name == 'collection' %}
  {% assign is_collection_page = true %}
{% endif %}

<div class="{{ grid_item_width }} product-loop-item wf-product-card">
  
  <div class="wf-card-image-wrap">
    
    {% if settings.show_product_badges %}
      {% if sold_out %}
        <div class="product-badge badge__sold-out">{{ 'products.product.out_of_stock' | t }}</div>
      {% endif %}

      {% if on_sale and sold_out == false and discount_percentage > 0 %}
        <div class="product-badge badge__sale">{{ 'products.product.save' | t: discount: discount_percentage }} </div>
      {% endif %}
    {% endif %}

    <a href="{{ product.url | within: collection }}" class="product-loop-image secondary-image-enabled">
      {%- assign img_url = product.featured_image | img_url: '1x1' | replace: '_1x1.', '_{width}x.' -%}
      {% unless product.featured_image == blank %}
        <img class="lazyload product-image_featured" src="{{ product.featured_image | img_url: '400x533', crop: 'center' }}"
          data-src="{{ img_url }}"
          data-widths="[180, 360, 540, 720, 900, 1080]"
          data-aspectratio="0.75"
          data-sizes="auto"
          alt="{{ product.featured_image.alt | escape }}">

        {%- assign secondary_img = product.images[1] -%}
        {% unless secondary_img == blank %}
          <img class="product-image_secondary" src="{{ secondary_img | img_url: '400x533', crop: 'center' }}" alt="{{ product.title | escape }}" loading="lazy">
        {% endunless %}
      {% endunless %}
    </a>

    {%- comment -%} EL DISEÑO ORIGINAL QUE TE GUSTÓ (INTEGRADO CON AJAX) {%- endcomment -%}
    {% if is_collection_page %}
      <div class="wf-quickadd wf-atc-section">
        {% if product.available %}
          {% if product.variants.size > 1 %}
            <p class="wf-quickadd__hint">Selecciona tu talla</p>
            <div class="wf-quickadd__sizes wf-atc-sizes">
              {%- for variant in product.variants -%}
                <button type="button" class="wf-quickadd__size js-qa-size {% unless variant.available %}is-oos{% endunless %}"
                        data-variant="{{ variant.id }}"
                        {% unless variant.available %}disabled{% endunless %}>
                  {{ variant.title }}
                </button>
              {%- endfor -%}
            </div>
            <button type="button" class="wf-quickadd__btn js-qa-btn js-qa-needs-size" disabled>
              <svg width="13" height="13" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"><path d="M6 2L3 6v14a2 2 0 002 2h14a2 2 0 002-2V6l-3-4z"/><line x1="3" y1="6" x2="21" y2="6"/><path d="M16 10a4 4 0 01-8 0"/></svg>
              Selecciona tu talla
            </button>
          {% else %}
            <button type="button" class="wf-quickadd__btn js-qa-btn is-ready" data-variant="{{ product.variants.first.id }}" style="margin-top:auto;">
              <svg width="13" height="13" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"><path d="M6 2L3 6v14a2 2 0 002 2h14a2 2 0 002-2V6l-3-4z"/><line x1="3" y1="6" x2="21" y2="6"/><path d="M16 10a4 4 0 01-8 0"/></svg>
              Añadir al carrito
            </button>
          {% endif %}
        {% else %}
          <button type="button" class="wf-quickadd__btn" disabled style="margin-top:auto;">
            Agotado
          </button>
        {% endif %}
      </div>
    {% endif %}

  </div>

  <div class="wf-card-info" style="padding-top: 0.75rem;">
    <a class="product-loop-title" href="{{ product.url | within: collection }}" style="margin-bottom: 0.2rem; display: block; font-weight:600; font-size:0.9rem;">{{ product.title }}</a>

    <a href="{{ product.url | within: collection }}" class="product-loop-price" style="display: block; margin-bottom: 0.75rem; color: rgba(255,255,255,0.6); font-size:0.85rem;">
      {% if on_sale %}
        <span class="visually-hidden">{{ 'products.general.regular_price' | t }}</span>
        <s><span class="money">{{ product.compare_at_price | money }}</span></s>
        {% if product.price_varies %}
          {% assign sale_price = product.price | money | prepend: '<span class="money">' | append: '</span>' %}
          {{ 'products.product.on_sale_from_html' | t: price: sale_price }}
        {% else %}
          <span class="money wf-price-sale" style="color:#E22120; font-weight:700;">{{ product.price | money }}</span>
        {% endif %}
      {% else %}
        {% if product.price_varies %}
          {% assign price = product.price | money | prepend: '<span class="money">' | append: '</span>' %}
          {{ 'products.general.from_text_html' | t: price: price }}
        {% else %}
          <span class="money">{{ product.price | money }}</span>
        {% endif %}
      {% endif %}
    </a>
  </div>

  {% if settings.add_spr_markup %}
   <div class="spr-badge__wrap">
      <a href="{{ product.url | within: collection }}#shopify-product-reviews">
        <span class="shopify-product-reviews-badge" data-id="{{ product.id }}"></span>
      </a>
    </div>
  {% endif %}
</div>

<script>
  /* Interceptor AJAX para el primer diseño (Panel Deslizante) */
  if (!window.wfQuickAddOriginalInit) {
    window.wfQuickAddOriginalInit = true;

    document.addEventListener('click', function(e) {
      
      // 1. Manejar clic en las tallas
      var sizeBtn = e.target.closest('.js-qa-size');
      if (sizeBtn && !sizeBtn.disabled) {
        var section = sizeBtn.closest('.wf-quickadd');
        var atcBtn = section.querySelector('.js-qa-needs-size');
        if (!atcBtn) return;
        
        var wasSelected = sizeBtn.classList.contains('is-selected');
        
        // Limpiar otras selecciones
        section.querySelectorAll('.js-qa-size').forEach(function(b) { b.classList.remove('is-selected'); });
        
        if (!wasSelected) {
          sizeBtn.classList.add('is-selected');
          atcBtn.setAttribute('data-variant', sizeBtn.getAttribute('data-variant'));
          atcBtn.disabled = false;
          atcBtn.classList.add('is-ready');
          atcBtn.innerHTML = '<svg width="13" height="13" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"><path d="M6 2L3 6v14a2 2 0 002 2h14a2 2 0 002-2V6l-3-4z"/><line x1="3" y1="6" x2="21" y2="6"/><path d="M16 10a4 4 0 01-8 0"/></svg> Añadir al carrito';
        } else {
          atcBtn.disabled = true;
          atcBtn.classList.remove('is-ready');
          atcBtn.innerHTML = '<svg width="13" height="13" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"><path d="M6 2L3 6v14a2 2 0 002 2h14a2 2 0 002-2V6l-3-4z"/><line x1="3" y1="6" x2="21" y2="6"/><path d="M16 10a4 4 0 01-8 0"/></svg> Selecciona tu talla';
        }
      }

      // 2. Manejar clic en "Añadir al carrito"
      var atcBtnClick = e.target.closest('.js-qa-btn:not([disabled])');
      if (atcBtnClick) {
        var variantId = atcBtnClick.getAttribute('data-variant');
        var originalText = atcBtnClick.innerHTML;
        
        atcBtnClick.innerHTML = 'Añadiendo...';
        atcBtnClick.disabled = true;

        fetch('/cart/add.js', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ id: variantId, quantity: 1 })
        })
        .then(function(res) { return res.json(); })
        .then(function(data) {
          atcBtnClick.innerHTML = '✓ Añadido';
          setTimeout(function() { 
            // Reset visual state
            var section = atcBtnClick.closest('.wf-quickadd');
            if (atcBtnClick.classList.contains('js-qa-needs-size')) {
              section.querySelectorAll('.js-qa-size').forEach(function(b) { b.classList.remove('is-selected'); });
              atcBtnClick.disabled = true;
              atcBtnClick.classList.remove('is-ready');
              atcBtnClick.innerHTML = '<svg width="13" height="13" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"><path d="M6 2L3 6v14a2 2 0 002 2h14a2 2 0 002-2V6l-3-4z"/><line x1="3" y1="6" x2="21" y2="6"/><path d="M16 10a4 4 0 01-8 0"/></svg> Selecciona tu talla';
            } else {
              atcBtnClick.innerHTML = originalText;
              atcBtnClick.disabled = false;
            }
          }, 2000);

          // Actualizar y abrir sidebar
          if (window.ajaxCart) { window.ajaxCart.load(); }
          var cartIcon = document.querySelector('a[href="/cart"], .js-drawer-open-right');
          if (cartIcon) cartIcon.click();
        })
        .catch(function() {
          atcBtnClick.innerHTML = 'Error';
          setTimeout(function() { 
            atcBtnClick.innerHTML = originalText; 
            atcBtnClick.disabled = false; 
          }, 2000);
        });
      }
    });
  }
</script>