{% unless grid_item_width %}
  {% assign grid_item_width = 'small-12 medium-3 large-3 columns' %}
{% endunless %}

{% assign on_sale = false %}
{% if product.compare_at_price > product.price %}
  {% assign on_sale = true %}
  {%- assign discount_percentage = product.compare_at_price | minus: product.price | times: 100 | divided_by: product.compare_at_price -%}
{% endif %}

{% assign sold_out = true %}
{% if product.available %}
  {% assign sold_out = false %}
{% endif %}

{%- comment -%} VALIDACIÓN: Mostrar botones SOLO en colecciones {%- endcomment -%}
{% assign is_collection_page = false %}
{% if template == 'collection' or template.name == 'collection' %}
  {% assign is_collection_page = true %}
{% endif %}

<div class="{{ grid_item_width }} product-loop-item wf-product-card">
  
  <div class="wf-card-image-wrap">
    
    {% if settings.show_product_badges %}
      {% if sold_out %}
        <div class="product-badge badge__sold-out">{{ 'products.product.out_of_stock' | t }}</div>
      {% endif %}

      {% if on_sale and sold_out == false and discount_percentage > 0 %}
        <div class="product-badge badge__sale">{{ 'products.product.save' | t: discount: discount_percentage }} </div>
      {% endif %}
    {% endif %}

    <a href="{{ product.url | within: collection }}" class="product-loop-image secondary-image-enabled">
      {%- assign img_url = product.featured_image | img_url: '1x1' | replace: '_1x1.', '_{width}x.' -%}
      {% unless product.featured_image == blank %}
        <img class="lazyload product-image_featured" src="{{ product.featured_image | img_url: '400x533', crop: 'center' }}"
          data-src="{{ img_url }}"
          data-widths="[180, 360, 540, 720, 900, 1080]"
          data-aspectratio="0.75"
          data-sizes="auto"
          alt="{{ product.featured_image.alt | escape }}">

        {%- assign secondary_img = product.images[1] -%}
        {% unless secondary_img == blank %}
          <img class="product-image_secondary" src="{{ secondary_img | img_url: '400x533', crop: 'center' }}" alt="{{ product.title | escape }}" loading="lazy">
        {% endunless %}
      {% endunless %}
    </a>

    {%- comment -%} DISEÑO UNIFICADO: 1 CLIC (SIEMPRE CUADRADOS) {%- endcomment -%}
    {% if is_collection_page %}
      <div class="wf-quickadd wf-atc-section">
        <div class="wf-quickadd__sizes wf-atc-sizes" style="padding-bottom: 0;">
          {%- for variant in product.variants -%}
            
            {%- comment -%} Filtro inteligente para mantener el cuadrado simétrico {%- endcomment -%}
            {%- assign var_title_down = variant.title | downcase -%}
            {%- assign final_title = variant.title -%}
            {%- if var_title_down contains 'default' or var_title_down contains 'unitalla' or var_title_down == 'os' or var_title_down contains 'unica' or var_title_down contains 'única' -%}
              {%- assign final_title = 'Unitalla' -%}
            {%- endif -%}

            <button type="button" class="wf-quickadd__size js-qa-direct-add {% unless variant.available %}is-oos{% endunless %}"
                    data-variant="{{ variant.id }}"
                    {% unless variant.available %}disabled{% endunless %} title="{{ variant.title }}">
              {{ final_title }}
            </button>

          {%- endfor -%}
        </div>
      </div>
    {% endif %}

  </div>

  <div class="wf-card-info" style="padding-top: 0.75rem;">
    <a class="product-loop-title" href="{{ product.url | within: collection }}" style="margin-bottom: 0.2rem; display: block; font-weight:600; font-size:0.9rem;">{{ product.title }}</a>

    <a href="{{ product.url | within: collection }}" class="product-loop-price" style="display: block; margin-bottom: 0.75rem; color: rgba(255,255,255,0.6); font-size:0.85rem;">
      {% if on_sale %}
        <span class="visually-hidden">{{ 'products.general.regular_price' | t }}</span>
        <s><span class="money">{{ product.compare_at_price | money }}</span></s>
        {% if product.price_varies %}
          {% assign sale_price = product.price | money | prepend: '<span class="money">' | append: '</span>' %}
          {{ 'products.product.on_sale_from_html' | t: price: sale_price }}
        {% else %}
          <span class="money wf-price-sale" style="color:#E22120; font-weight:700;">{{ product.price | money }}</span>
        {% endif %}
      {% else %}
        {% if product.price_varies %}
          {% assign price = product.price | money | prepend: '<span class="money">' | append: '</span>' %}
          {{ 'products.general.from_text_html' | t: price: price }}
        {% else %}
          <span class="money">{{ product.price | money }}</span>
        {% endif %}
      {% endif %}
    </a>
  </div>

  {% if settings.add_spr_markup %}
   <div class="spr-badge__wrap">
      <a href="{{ product.url | within: collection }}#shopify-product-reviews">
        <span class="shopify-product-reviews-badge" data-id="{{ product.id }}"></span>
      </a>
    </div>
  {% endif %}
</div>

<script>
  if (!window.wfQuickAddDirectInit) {
    window.wfQuickAddDirectInit = true;

    /* ========================================================
       1. LÓGICA DE AÑADIR AL CARRITO (1-CLIC)
       ======================================================== */
    document.addEventListener('click', function(e) {
      var btn = e.target.closest('.js-qa-direct-add');
      if (!btn || btn.disabled) return;

      e.preventDefault();
      e.stopPropagation(); 
      
      var variantId = btn.getAttribute('data-variant');
      if (!variantId) return;

      var originalText = btn.innerHTML;
      btn.innerHTML = '<span style="opacity:0.5;">...</span>';
      btn.disabled = true;

      fetch('/cart/add.js', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ id: variantId, quantity: 1 })
      })
      .then(function(res) { return res.json(); })
      .then(function(data) {
        
        btn.innerHTML = '✓';
        setTimeout(function() { btn.innerHTML = originalText; btn.disabled = false; }, 2000);

        // Actualizamos el mini-carrito y burbuja
        if (window.ajaxCart && typeof window.ajaxCart.load === 'function') { window.ajaxCart.load(); }
        fetch('/cart.js').then(function(r) { return r.json(); }).then(function(cart) {
          var count = document.getElementById('CartCount');
          if (count) { count.textContent = cart.item_count; }
        });

        // Abrimos el sidebar simulando el clic nativo
        setTimeout(function() {
           var cartIcon = document.querySelector('.site-header__cart-toggle, #cart-icon, .js-drawer-open-right, a[href="/cart"]');
           if (cartIcon) {
             cartIcon.click();
           }
        }, 150);

      })
      .catch(function() {
        btn.innerHTML = 'X';
        setTimeout(function() { btn.innerHTML = originalText; btn.disabled = false; }, 2000);
      });
    });

    /* ========================================================
       2. LIMPIADOR SUAVE (ADIÓS CAPA FANTASMA)
       ======================================================== */
    // En lugar de forzar estilos CSS, obligamos al tema a usar su propia lógica de cierre
    document.addEventListener('click', function(e) {
      var isOverlay = e.target.matches('.js-off-canvas-overlay') || e.target.closest('.js-off-canvas-overlay');
      
      if (isOverlay) {
        // 1. Buscamos la 'X' de tu carrito y simulamos que el usuario le dio clic
        var closeBtn = document.querySelector('#cartSidebar .close-button, .off-canvas .close-button');
        if (closeBtn) {
          closeBtn.click();
        }

        // 2. Limpieza de emergencia por si el tema se traba (removiendo clases, no inyectando CSS)
        setTimeout(function() {
          document.body.classList.remove('is-moved', 'is-transition-overlap', 'cart-open');
          document.querySelectorAll('.off-canvas.is-open').forEach(function(el){
            el.classList.remove('is-open');
          });
        }, 300);
      }
    });

    /* ========================================================
       3. LÓGICA DE DOBLE TOQUE EN MÓVIL (TAP-TO-FOCUS)
       ======================================================== */
    document.addEventListener('click', function(e) {
      if (window.innerWidth > 768) return; 

      var imgLink = e.target.closest('.product-loop-image');
      
      if (imgLink) {
        var card = imgLink.closest('.wf-product-card');
        if (card) {
          if (!card.classList.contains('is-mobile-active')) {
            e.preventDefault(); 
            
            document.querySelectorAll('.wf-product-card.is-mobile-active').forEach(function(c) {
              if (c !== card) c.classList.remove('is-mobile-active');
            });
            
            card.classList.add('is-mobile-active');
          }
        }
      } else {
        var isSizeBtn = e.target.closest('.js-qa-direct-add');
        if (!isSizeBtn) {
          document.querySelectorAll('.wf-product-card.is-mobile-active').forEach(function(c) {
            c.classList.remove('is-mobile-active');
          });
        }
      }
    });
  }
</script>