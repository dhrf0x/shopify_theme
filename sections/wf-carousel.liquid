<div class="wf-carousel-section" id="wf-carousel-{{ section.id }}">
  <div class="row">
    <div class="small-12 columns">
      
      {% if section.settings.title != blank %}
        <div class="wf-carousel-header">
          <h2 class="wf-carousel-title">{{ section.settings.title }}</h2>
          {% if section.settings.link_url != blank %}
            <a href="{{ section.settings.link_url }}" class="wf-carousel-link">{{ section.settings.link_text }}</a>
          {% endif %}
        </div>
      {% endif %}

    </div>
  </div>

  <div class="wf-carousel-wrapper">
    <div class="wf-carousel-track">
      {% for block in section.blocks %}
        
        {% assign prod = all_products[block.settings.product] %}
        {% assign link_target = block.settings.link | default: prod.url %}
        {% assign slide_title = block.settings.title | default: prod.title %}
        {% assign slide_image = block.settings.image | default: prod.featured_image %}

        <div class="wf-carousel-slide" {{ block.shopify_attributes }}>
          <div class="wf-carousel-img-wrap">
            
            {% if prod != blank %}
              <button type="button" class="wf-carousel-heart js-add-to-favs" data-product-handle="{{ prod.handle }}" aria-label="Añadir a favoritos">
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                  <path d="M20.84 4.61a5.5 5.5 0 0 0-7.78 0L12 5.67l-1.06-1.06a5.5 5.5 0 0 0-7.78 7.78l1.06 1.06L12 21.23l7.78-7.78 1.06-1.06a5.5 5.5 0 0 0 0-7.78z"></path>
                </svg>
              </button>
            {% endif %}

            <a href="{{ link_target }}" style="display: block; width: 100%; height: 100%;">
              {% if slide_image != blank %}
                <img class="lazyload" 
                     src="{{ slide_image | img_url: '400x533', crop: 'center' }}" 
                     data-src="{{ slide_image | img_url: '800x1066', crop: 'center' }}" 
                     alt="{{ slide_title | escape }}" 
                     loading="lazy">
              {% else %}
                {{ 'collection-1' | placeholder_svg_tag: 'placeholder-svg' }}
              {% endif %}
              
              <div class="wf-carousel-overlay">
                {% if block.settings.subtext != blank %}
                  <span class="wf-carousel-subtext">{{ block.settings.subtext }}</span>
                {% endif %}
                {% if slide_title != blank %}
                  <h3 class="wf-carousel-heading">{{ slide_title }}</h3>
                {% endif %}
              </div>
            </a>

          </div>
        </div>
      {% endfor %}
    </div>
  </div>
</div>

<script>
  // SISTEMA DE FAVORITOS Y TOAST NOTIFICATION
  document.addEventListener('DOMContentLoaded', function() {
    var favButtons = document.querySelectorAll('#wf-carousel-{{ section.id }} .js-add-to-favs');
    var favs = JSON.parse(localStorage.getItem('wf_favorites')) || [];
    
    // Función creadora del Toast
    function showFavToast(message) {
      var toast = document.getElementById('wf-fav-toast');
      if (!toast) {
        toast = document.createElement('div');
        toast.id = 'wf-fav-toast';
        toast.className = 'wf-fav-toast';
        document.body.appendChild(toast);
      }
      
      toast.innerHTML = '<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M20.84 4.61a5.5 5.5 0 0 0-7.78 0L12 5.67l-1.06-1.06a5.5 5.5 0 0 0-7.78 7.78l1.06 1.06L12 21.23l7.78-7.78 1.06-1.06a5.5 5.5 0 0 0 0-7.78z"></path></svg>' + message;
      
      // Reiniciamos animación
      toast.classList.remove('is-visible');
      void toast.offsetWidth; 
      toast.classList.add('is-visible');

      // Ocultar después de 3 segundos
      if (window.favToastTimeout) clearTimeout(window.favToastTimeout);
      window.favToastTimeout = setTimeout(function() {
        toast.classList.remove('is-visible');
      }, 3000);
    }

    favButtons.forEach(function(btn) {
      var handle = btn.getAttribute('data-product-handle');
      if (favs.indexOf(handle) !== -1) {
        btn.classList.add('is-active');
      }
      
      btn.addEventListener('click', function(e) {
        e.preventDefault();
        e.stopPropagation(); 
        
        var currentHandle = this.getAttribute('data-product-handle');
        var currentFavs = JSON.parse(localStorage.getItem('wf_favorites')) || [];
        
        if (currentFavs.indexOf(currentHandle) !== -1) {
          // Remover
          currentFavs = currentFavs.filter(function(h) { return h !== currentHandle; });
          this.classList.remove('is-active');
          showFavToast('Eliminado de Favoritos');
        } else {
          // Agregar
          currentFavs.push(currentHandle);
          this.classList.add('is-active');
          showFavToast('Añadido a Favoritos');
        }
        
        localStorage.setItem('wf_favorites', JSON.stringify(currentFavs));
        window.dispatchEvent(new CustomEvent('wf-favorites-updated'));
      });
    });
  });
</script>

{% schema %}
{
  "name": "Carrusel WF",
  "settings": [
    {
      "type": "text",
      "id": "title",
      "label": "Título de la sección",
      "default": "Compra por Categoría"
    },
    {
      "type": "text",
      "id": "link_text",
      "label": "Texto del enlace",
      "default": "Ver todo"
    },
    {
      "type": "url",
      "id": "link_url",
      "label": "Enlace superior"
    }
  ],
  "blocks": [
    {
      "type": "slide",
      "name": "Tarjeta",
      "settings": [
        {
          "type": "product",
          "id": "product",
          "label": "Producto (Requerido para Favoritos)",
          "info": "Si seleccionas un producto, el corazón funcionará mágicamente."
        },
        {
          "type": "image_picker",
          "id": "image",
          "label": "Imagen (Opcional - Reemplaza la del producto)"
        },
        {
          "type": "text",
          "id": "title",
          "label": "Título (Opcional - Reemplaza al del producto)"
        },
        {
          "type": "text",
          "id": "subtext",
          "label": "Etiqueta superior (Opcional)",
          "default": "NUEVO"
        },
        {
          "type": "url",
          "id": "link",
          "label": "Enlace (Opcional - Reemplaza al del producto)"
        }
      ]
    }
  ],
  "presets": [
    {
      "name": "Carrusel WF",
      "category": "Custom",
      "blocks": [
        { "type": "slide" },
        { "type": "slide" },
        { "type": "slide" }
      ]
    }
  ]
}
{% endschema %}