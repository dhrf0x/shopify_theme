{%- comment -%}
  Barra de Anuncios — WF Urban Muscle v5.7
  Sección standalone, incluida en layout/theme.liquid
  Subir a: sections/announcement-bar.liquid
{%- endcomment -%}

{%- comment -%} 
  LÓGICA DE VISIBILIDAD - usa blank check en lugar de comparar con nil 
{%- endcomment -%}
{%- assign _vis = section.settings.ann_visibility | default: 'all' -%}
{%- assign _enabled = section.settings.ann_enabled -%}

{%- assign _show = false -%}
{%- if _vis == 'all' or _vis == blank or _vis == nil -%}
  {%- assign _show = true -%}
{%- elsif _vis == 'home' and template == 'index' -%}
  {%- assign _show = true -%}
{%- elsif _vis == 'not_home' and template != 'index' -%}
  {%- assign _show = true -%}
{%- endif -%}
{%- unless _enabled -%}{%- assign _show = false -%}{%- endunless -%}

{%- comment -%} Recolectar mensajes definidos {%- endcomment -%}
{%- assign _msgs = '' | split: ',' -%}
{%- assign _urls = '' | split: ',' -%}

{%- if section.settings.ann_msg1 != blank -%}
  {%- assign _msgs = _msgs | push: section.settings.ann_msg1 -%}
  {%- assign _urls = _urls | push: section.settings.ann_link1 -%}
{%- endif -%}
{%- if section.settings.ann_msg2 != blank -%}
  {%- assign _msgs = _msgs | push: section.settings.ann_msg2 -%}
  {%- assign _urls = _urls | push: section.settings.ann_link2 -%}
{%- endif -%}
{%- if section.settings.ann_msg3 != blank -%}
  {%- assign _msgs = _msgs | push: section.settings.ann_msg3 -%}
  {%- assign _urls = _urls | push: section.settings.ann_link3 -%}
{%- endif -%}
{%- if section.settings.ann_msg4 != blank -%}
  {%- assign _msgs = _msgs | push: section.settings.ann_msg4 -%}
  {%- assign _urls = _urls | push: section.settings.ann_link4 -%}
{%- endif -%}
{%- if section.settings.ann_msg5 != blank -%}
  {%- assign _msgs = _msgs | push: section.settings.ann_msg5 -%}
  {%- assign _urls = _urls | push: section.settings.ann_link5 -%}
{%- endif -%}
{%- assign _total = _msgs.size -%}

{%- comment -%} 
  RENDER: Solo renderiza si hay al menos un mensaje. 
  Si no hay mensajes configurados, usa el mensaje por defecto del schema.
{%- endcomment -%}
{%- if _show -%}
{%- assign _bg    = section.settings.ann_bg    | default: '#cc0000' -%}
{%- assign _color = section.settings.ann_color | default: '#ffffff' -%}
{%- assign _size  = section.settings.ann_size  | default: 13 -%}
{%- assign _speed = section.settings.ann_speed | default: 4 -%}

<div class="wf-ann" id="wf-ann-{{ section.id }}"
  style="background:{{ _bg }};color:{{ _color }};font-size:{{ _size }}px;">

  {%- if _total > 1 -%}
  <button class="wf-ann__nav wf-ann__prev"
    onclick="window['wfAnnPrev_{{ section.id }}'] && window['wfAnnPrev_{{ section.id }}']()" aria-label="Anterior">&#8249;</button>
  {%- endif -%}

  <div class="wf-ann__track">
    {%- if _total == 0 -%}
      {%- comment -%} Mensaje de fallback cuando el schema default no ha cargado {%- endcomment -%}
      <span class="wf-ann__slide active">{{ section.settings.ann_msg1 | default: '✦ Bienvenido a WF Urban Muscle ✦' }}</span>
    {%- else -%}
      {%- for _m in _msgs -%}
        {%- assign _u = _urls[forloop.index0] -%}
        <span class="wf-ann__slide{% if forloop.first %} active{% endif %}">
          {%- if _u != blank -%}
            <a href="{{ _u }}" style="color:inherit;text-decoration:underline;">{{ _m }}</a>
          {%- else -%}{{ _m }}{%- endif -%}
        </span>
      {%- endfor -%}
    {%- endif -%}
  </div>

  {%- if _total > 1 -%}
  <button class="wf-ann__nav wf-ann__next"
    onclick="window['wfAnnNext_{{ section.id }}'] && window['wfAnnNext_{{ section.id }}']()" aria-label="Siguiente">&#8250;</button>
  {%- endif -%}
</div>

<style>
.wf-ann {
  position: relative;
  width: 100%;
  display: flex;
  align-items: center;
  justify-content: center;
  min-height: 36px;
  padding: 7px 44px;
  text-align: center;
  font-weight: 600;
  letter-spacing: 0.03em;
  box-sizing: border-box;
  z-index: 10;
}
.wf-ann__track {
  flex: 1;
  display: flex;
  align-items: center;
  justify-content: center;
  overflow: hidden;
  min-height: 1.4em;
}
.wf-ann__slide { display: none; }
.wf-ann__slide.active { display: inline; }
.wf-ann__nav {
  position: absolute;
  top: 50%; transform: translateY(-50%);
  background: none; border: none;
  color: inherit; font-size: 20px; line-height: 1;
  cursor: pointer; padding: 0 8px; opacity: 0.6;
  transition: opacity 0.2s;
}
.wf-ann__nav:hover { opacity: 1; }
.wf-ann__prev { left: 8px; }
.wf-ann__next { right: 8px; }
</style>

{%- if _total > 1 -%}
<script>
(function() {
  // Carrusel autocontenido — ID único por sección
  var annId    = '{{ section.id }}';
  var speed    = {{ _speed | times: 1000 }};
  var total    = {{ _total }};
  var current  = 0;
  var timer    = null;
  var slides   = null;

  function getSlides() {
    return document.querySelectorAll('#wf-ann-' + annId + ' .wf-ann__slide');
  }

  function showSlide(n) {
    if (!slides || !slides.length) slides = getSlides();
    if (!slides.length) return;
    slides[current].classList.remove('active');
    current = ((n % total) + total) % total;
    slides[current].classList.add('active');
  }

  function startAuto() {
    stopAuto();
    timer = setInterval(function() {
      showSlide(current + 1);
    }, speed);
  }

  function stopAuto() {
    if (timer) { clearInterval(timer); timer = null; }
  }

  // Exponer navegación manual al onclick del HTML
  window['wfAnnPrev_' + annId] = function() { stopAuto(); showSlide(current - 1); startAuto(); };
  window['wfAnnNext_' + annId] = function() { stopAuto(); showSlide(current + 1); startAuto(); };

  // Arrancar cuando el DOM esté listo
  function init() {
    slides = getSlides();
    if (!slides.length) return;
    // Asegurar estado inicial correcto
    for (var i = 0; i < slides.length; i++) slides[i].classList.remove('active');
    slides[0].classList.add('active');
    current = 0;
    startAuto();
  }

  if (document.readyState === 'loading') {
    document.addEventListener('DOMContentLoaded', init);
  } else {
    init();
  }
  // Reiniciar si Shopify recarga la sección en el editor
  document.addEventListener('shopify:section:load', function(e) {
    if (e.detail && e.detail.sectionId === annId) { stopAuto(); init(); }
  });
})();
</script>
{%- endif -%}
{%- endif -%}

{% schema %}
{
  "name": "Barra de Anuncios",
  "settings": [
    { "type": "header",   "content": "— Activación —" },
    { "type": "checkbox", "id": "ann_enabled",    "label": "Activar barra", "default": true },
    {
      "type": "select",
      "id": "ann_visibility",
      "label": "Mostrar en",
      "default": "all",
      "options": [
        { "value": "all",      "label": "Todas las páginas" },
        { "value": "home",     "label": "Solo inicio"       },
        { "value": "not_home", "label": "Todas excepto inicio" }
      ]
    },
    { "type": "header", "content": "— Mensajes (hasta 5) —" },
    { "type": "text", "id": "ann_msg1", "label": "Mensaje 1", "default": "✦ Envío gratis en pedidos mayores a $999 ✦" },
    { "type": "url",  "id": "ann_link1", "label": "Enlace 1 (opcional)" },
    { "type": "text", "id": "ann_msg2", "label": "Mensaje 2" },
    { "type": "url",  "id": "ann_link2", "label": "Enlace 2 (opcional)" },
    { "type": "text", "id": "ann_msg3", "label": "Mensaje 3" },
    { "type": "url",  "id": "ann_link3", "label": "Enlace 3 (opcional)" },
    { "type": "text", "id": "ann_msg4", "label": "Mensaje 4" },
    { "type": "url",  "id": "ann_link4", "label": "Enlace 4 (opcional)" },
    { "type": "text", "id": "ann_msg5", "label": "Mensaje 5" },
    { "type": "url",  "id": "ann_link5", "label": "Enlace 5 (opcional)" },
    { "type": "header", "content": "— Estilo —" },
    { "type": "color", "id": "ann_bg",    "label": "Fondo",    "default": "#cc0000" },
    { "type": "color", "id": "ann_color", "label": "Texto",    "default": "#ffffff" },
    { "type": "range", "id": "ann_size",  "label": "Tamaño fuente", "min": 10, "max": 18, "step": 1, "unit": "px", "default": 13 },
    { "type": "range", "id": "ann_speed", "label": "Velocidad carrusel", "min": 2, "max": 10, "step": 1, "unit": "s",  "default": 4  }
  ],
  "presets": [{ "name": "Barra de Anuncios", "category": "Content" }]
}
{% endschema %}
