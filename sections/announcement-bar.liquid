{%- comment -%}
  Barra de Anuncios — WF Urban Muscle
  Incluida en layout/theme.liquid con: {% section 'announcement-bar' %}
  Subir a: sections/announcement-bar.liquid
{%- endcomment -%}

{%- comment -%} ── Visibilidad por página ── {%- endcomment -%}
{%- assign _show = false -%}
{%- if section.settings.ann_visibility == 'all' -%}
  {%- assign _show = true -%}
{%- elsif section.settings.ann_visibility == 'home' and template == 'index' -%}
  {%- assign _show = true -%}
{%- elsif section.settings.ann_visibility == 'not_home' and template != 'index' -%}
  {%- assign _show = true -%}
{%- endif -%}

{%- comment -%} Si ann_enabled está desactivado, no mostrar {%- endcomment -%}
{%- if section.settings.ann_enabled == false -%}
  {%- assign _show = false -%}
{%- endif -%}

{%- comment -%} Recopilar mensajes no vacíos {%- endcomment -%}
{%- assign _msgs = '' | split: '|' -%}
{%- assign _urls = '' | split: '|' -%}
{%- assign _m = section.settings.ann_msg1 -%}
{%- if _m != blank -%}{%- assign _msgs = _msgs | push: _m -%}{%- assign _urls = _urls | push: section.settings.ann_link1 -%}{%- endif -%}
{%- assign _m = section.settings.ann_msg2 -%}
{%- if _m != blank -%}{%- assign _msgs = _msgs | push: _m -%}{%- assign _urls = _urls | push: section.settings.ann_link2 -%}{%- endif -%}
{%- assign _m = section.settings.ann_msg3 -%}
{%- if _m != blank -%}{%- assign _msgs = _msgs | push: _m -%}{%- assign _urls = _urls | push: section.settings.ann_link3 -%}{%- endif -%}
{%- assign _m = section.settings.ann_msg4 -%}
{%- if _m != blank -%}{%- assign _msgs = _msgs | push: _m -%}{%- assign _urls = _urls | push: section.settings.ann_link4 -%}{%- endif -%}
{%- assign _m = section.settings.ann_msg5 -%}
{%- if _m != blank -%}{%- assign _msgs = _msgs | push: _m -%}{%- assign _urls = _urls | push: section.settings.ann_link5 -%}{%- endif -%}

{%- assign _total = _msgs.size -%}

{%- if _show and _total > 0 -%}
<div class="wf-ann" style="background:{{ section.settings.ann_bg }};color:{{ section.settings.ann_color }};font-size:{{ section.settings.ann_size }}px;">
  {%- if _total > 1 -%}
  <button class="wf-ann__nav wf-ann__nav--prev" onclick="wfAnnPrev('{{ section.id }}')" aria-label="Anterior">&#8249;</button>
  {%- endif -%}

  <div class="wf-ann__wrap">
    {%- for _msg in _msgs -%}
      {%- assign _url = _urls[forloop.index0] -%}
      <span class="wf-ann__item{% if forloop.first %} active{% endif %}">
        {%- if _url != blank -%}<a href="{{ _url }}" style="color:inherit;text-decoration:underline dotted;">{{ _msg }}</a>
        {%- else -%}{{ _msg }}
        {%- endif -%}
      </span>
    {%- endfor -%}
  </div>

  {%- if _total > 1 -%}
  <button class="wf-ann__nav wf-ann__nav--next" onclick="wfAnnNext('{{ section.id }}')" aria-label="Siguiente">&#8250;</button>
  {%- endif -%}
</div>

<style>
.wf-ann {
  width: 100%;
  display: flex;
  align-items: center;
  justify-content: center;
  min-height: 36px;
  padding: 6px 40px;
  font-size: 13px;
  font-weight: 600;
  letter-spacing: 0.03em;
  text-align: center;
  position: relative;
  z-index: 999;
  box-sizing: border-box;
}
.wf-ann__wrap {
  flex: 1;
  overflow: hidden;
  text-align: center;
  position: relative;
  min-height: 1.4em;
}
.wf-ann__item {
  display: none;
  white-space: nowrap;
}
.wf-ann__item.active {
  display: inline;
}
.wf-ann__nav {
  position: absolute;
  top: 50%;
  transform: translateY(-50%);
  background: transparent;
  border: none;
  color: inherit;
  font-size: 22px;
  line-height: 1;
  cursor: pointer;
  padding: 0 8px;
  opacity: 0.65;
  transition: opacity 0.2s;
  z-index: 1;
}
.wf-ann__nav:hover { opacity: 1; }
.wf-ann__nav--prev { left: 6px; }
.wf-ann__nav--next { right: 6px; }
</style>

<script>
(function() {
  var _annStates = window._annStates || {};
  window._annStates = _annStates;

  function wfAnnInit(id, total, speed) {
    _annStates[id] = { cur: 0, total: total };
    if (total > 1) {
      _annStates[id].timer = setInterval(function() { wfAnnGo(id, 1); }, speed * 1000);
    }
  }

  function wfAnnGo(id, dir) {
    var s = _annStates[id];
    if (!s) return;
    var items = document.querySelectorAll('.wf-ann__item');
    if (!items.length) return;
    items[s.cur].classList.remove('active');
    s.cur = (s.cur + dir + s.total) % s.total;
    items[s.cur].classList.add('active');
  }

  window.wfAnnPrev = function(id) {
    clearInterval((_annStates[id] || {}).timer);
    wfAnnGo(id, -1);
  };
  window.wfAnnNext = function(id) {
    clearInterval((_annStates[id] || {}).timer);
    wfAnnGo(id, 1);
  };

  wfAnnInit('{{ section.id }}', {{ _total }}, {{ section.settings.ann_speed | default: 4 }});
})();
</script>
{%- endif -%}

{% schema %}
{
  "name": "Barra de Anuncios",
  "settings": [
    {
      "type": "header",
      "content": "— Activación —"
    },
    {
      "type": "checkbox",
      "id": "ann_enabled",
      "label": "Activar barra de anuncios",
      "default": true
    },
    {
      "type": "select",
      "id": "ann_visibility",
      "label": "Mostrar en",
      "default": "all",
      "options": [
        { "value": "all",      "label": "Todas las páginas"           },
        { "value": "home",     "label": "Solo en la página de inicio" },
        { "value": "not_home", "label": "En todas excepto el inicio"  }
      ]
    },
    {
      "type": "header",
      "content": "— Mensajes (hasta 5) —"
    },
    {
      "type": "text",
      "id": "ann_msg1",
      "label": "Mensaje 1",
      "default": "✦ Envío gratis en pedidos mayores a $999 ✦"
    },
    {
      "type": "url",
      "id": "ann_link1",
      "label": "Enlace 1 (opcional)"
    },
    {
      "type": "text",
      "id": "ann_msg2",
      "label": "Mensaje 2"
    },
    {
      "type": "url",
      "id": "ann_link2",
      "label": "Enlace 2 (opcional)"
    },
    {
      "type": "text",
      "id": "ann_msg3",
      "label": "Mensaje 3"
    },
    {
      "type": "url",
      "id": "ann_link3",
      "label": "Enlace 3 (opcional)"
    },
    {
      "type": "text",
      "id": "ann_msg4",
      "label": "Mensaje 4"
    },
    {
      "type": "url",
      "id": "ann_link4",
      "label": "Enlace 4 (opcional)"
    },
    {
      "type": "text",
      "id": "ann_msg5",
      "label": "Mensaje 5"
    },
    {
      "type": "url",
      "id": "ann_link5",
      "label": "Enlace 5 (opcional)"
    },
    {
      "type": "header",
      "content": "— Estilo —"
    },
    {
      "type": "color",
      "id": "ann_bg",
      "label": "Color de fondo",
      "default": "#cc0000"
    },
    {
      "type": "color",
      "id": "ann_color",
      "label": "Color del texto",
      "default": "#ffffff"
    },
    {
      "type": "range",
      "id": "ann_size",
      "label": "Tamaño de fuente",
      "min": 10,
      "max": 18,
      "step": 1,
      "unit": "px",
      "default": 13
    },
    {
      "type": "range",
      "id": "ann_speed",
      "label": "Velocidad del carrusel",
      "min": 2,
      "max": 10,
      "step": 1,
      "unit": "s",
      "default": 4
    }
  ],
  "presets": [
    {
      "name": "Barra de Anuncios",
      "category": "Content"
    }
  ]
}
{% endschema %}
