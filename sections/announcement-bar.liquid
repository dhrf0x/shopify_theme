{%- comment -%}
  Barra de Anuncios v5.9 — WF Urban Muscle
  Carrusel 100% CSS con @keyframes — sin JavaScript para la rotación
  Subir a: sections/announcement-bar.liquid
{%- endcomment -%}

{%- comment -%}── Visibilidad ──{%- endcomment -%}
{%- assign _vis     = section.settings.ann_visibility | default: 'all' -%}
{%- assign _enabled = section.settings.ann_enabled -%}
{%- assign _show    = false -%}
{%- if _vis == 'all' or _vis == blank or _vis == nil -%}{%- assign _show = true -%}
{%- elsif _vis == 'home' and template == 'index' -%}{%- assign _show = true -%}
{%- elsif _vis == 'not_home' and template != 'index' -%}{%- assign _show = true -%}
{%- endif -%}
{%- if _enabled == false -%}{%- assign _show = false -%}{%- endif -%}

{%- comment -%}── Mensajes ──{%- endcomment -%}
{%- assign _msgs = '' | split: ',' -%}
{%- assign _urls = '' | split: ',' -%}
{%- if section.settings.ann_msg1 != blank -%}
  {%- assign _msgs = _msgs | push: section.settings.ann_msg1 -%}
  {%- assign _urls = _urls | push: section.settings.ann_link1 -%}
{%- endif -%}
{%- if section.settings.ann_msg2 != blank -%}
  {%- assign _msgs = _msgs | push: section.settings.ann_msg2 -%}
  {%- assign _urls = _urls | push: section.settings.ann_link2 -%}
{%- endif -%}
{%- if section.settings.ann_msg3 != blank -%}
  {%- assign _msgs = _msgs | push: section.settings.ann_msg3 -%}
  {%- assign _urls = _urls | push: section.settings.ann_link3 -%}
{%- endif -%}
{%- assign _total = _msgs.size -%}

{%- if _show -%}
{%- assign _speed = section.settings.ann_speed | default: 4 -%}
{%- assign _bg    = section.settings.ann_bg    | default: '#cc0000' -%}
{%- assign _color = section.settings.ann_color | default: '#ffffff' -%}
{%- assign _size  = section.settings.ann_size  | default: 13 -%}

{%- comment -%}
  Matemáticas para los keyframes CSS:
  - _cycle  = duración total del ciclo completo (N mensajes × segundos cada uno)
  - _pct    = % del ciclo que ocupa cada mensaje (100 / N, entero)
  - El keyframe describe "aparezco al inicio de mi ventana, me quedo, desaparezco al final"
  - Cada slide usa el MISMO keyframe pero con animation-delay = índice × _speed
{%- endcomment -%}
{%- assign _sid   = section.id -%}
{%- assign _cycle = _total | times: _speed -%}

{%- comment -%} Calcular porcentajes del keyframe según cuántos mensajes hay {%- endcomment -%}
{%- if _total == 1 -%}
  {%- assign _pct_in   = 3 -%}
  {%- assign _pct_hold = 97 -%}
  {%- assign _pct_out  = 100 -%}
{%- elsif _total == 2 -%}
  {%- assign _pct_in   = 4 -%}
  {%- assign _pct_hold = 44 -%}
  {%- assign _pct_out  = 50 -%}
{%- else -%}
  {%- comment -%} 3 mensajes: cada uno ocupa 33% del ciclo {%- endcomment -%}
  {%- assign _pct_in   = 3 -%}
  {%- assign _pct_hold = 29 -%}
  {%- assign _pct_out  = 33 -%}
{%- endif -%}

<div class="wf-ann" id="wf-ann-{{ _sid }}"
  style="background:{{ _bg }};color:{{ _color }};font-size:{{ _size }}px;">

  <div class="wf-ann__wrap">
    {%- for _m in _msgs -%}
      {%- assign _u = _urls[forloop.index0] -%}
      <span class="wf-ann__slide wf-ann__slide--{{ forloop.index }}">
        {%- if _u != blank -%}
          <a href="{{ _u }}" style="color:inherit;text-decoration:underline dotted;">{{ _m }}</a>
        {%- else -%}{{ _m }}{%- endif -%}
      </span>
    {%- endfor -%}
  </div>

</div>

<style>
/* ── Barra contenedor ── */
#wf-ann-{{ _sid }} {
  position: relative;
  width: 100%;
  min-height: 38px;
  display: flex;
  align-items: stretch;
  justify-content: center;
  text-align: center;
  font-weight: 600;
  letter-spacing: 0.03em;
  box-sizing: border-box;
  z-index: 10;
  overflow: hidden;
}
#wf-ann-{{ _sid }} .wf-ann__wrap {
  flex: 1;
  position: relative;
  min-height: 38px;
  display: flex;
  align-items: center;
  justify-content: center;
  padding: 8px 16px;
}

/* ── Slides — apilados, todos en position:absolute ── */
#wf-ann-{{ _sid }} .wf-ann__slide {
  position: absolute;
  left: 0; right: 0;
  display: flex;
  align-items: center;
  justify-content: center;
  padding: 0 8px;
  opacity: 0;
  {%- if _total > 1 -%}
  animation: wfAnn{{ _sid }} {{ _cycle }}s linear infinite;
  animation-fill-mode: backwards;
  {%- endif -%}
}

{%- if _total == 1 -%}
/* Un solo mensaje: siempre visible, sin animación */
#wf-ann-{{ _sid }} .wf-ann__slide--1 { opacity: 1; position: relative; }
{%- else -%}
/* Delays escalonados: cada slide empieza su ventana en i × _speed segundos */
#wf-ann-{{ _sid }} .wf-ann__slide--1 { animation-delay: 0s; }
{%- if _total >= 2 -%}
#wf-ann-{{ _sid }} .wf-ann__slide--2 { animation-delay: {{ _speed }}s; }
{%- endif -%}
{%- if _total >= 3 -%}
#wf-ann-{{ _sid }} .wf-ann__slide--3 { animation-delay: {{ _speed | times: 2 }}s; }
{%- endif -%}
{%- endif -%}

/* ── Keyframe: aparezco → me quedo → desaparezco → invisible ── */
@keyframes wfAnn{{ _sid }} {
  0%                   { opacity: 0; transform: translateY(5px); }
  {{ _pct_in }}%       { opacity: 1; transform: translateY(0); }
  {{ _pct_hold }}%     { opacity: 1; transform: translateY(0); }
  {{ _pct_out }}%      { opacity: 0; transform: translateY(-5px); }
  {{ _pct_out | plus: 1 }}% { opacity: 0; transform: translateY(0); }
  100%                 { opacity: 0; transform: translateY(0); }
}
</style>

{%- endif -%}

{% schema %}
{
  "name": "Barra de Anuncios",
  "settings": [
    { "type": "header",   "content": "— Activación —" },
    { "type": "checkbox", "id": "ann_enabled", "label": "Activar barra", "default": true },
    {
      "type": "select", "id": "ann_visibility", "label": "Mostrar en", "default": "all",
      "options": [
        { "value": "all",      "label": "Todas las páginas" },
        { "value": "home",     "label": "Solo inicio" },
        { "value": "not_home", "label": "Todas excepto inicio" }
      ]
    },
    { "type": "header", "content": "— Mensajes (hasta 3) —" },
    { "type": "text", "id": "ann_msg1", "label": "Mensaje 1", "default": "✦ Envío gratis en pedidos mayores a $999 ✦" },
    { "type": "url",  "id": "ann_link1", "label": "Enlace 1 (opcional)" },
    { "type": "text", "id": "ann_msg2", "label": "Mensaje 2" },
    { "type": "url",  "id": "ann_link2", "label": "Enlace 2 (opcional)" },
    { "type": "text", "id": "ann_msg3", "label": "Mensaje 3" },
    { "type": "url",  "id": "ann_link3", "label": "Enlace 3 (opcional)" },
    { "type": "header", "content": "— Estilo —" },
    { "type": "color", "id": "ann_bg",    "label": "Fondo",  "default": "#cc0000" },
    { "type": "color", "id": "ann_color", "label": "Texto",  "default": "#ffffff" },
    { "type": "range", "id": "ann_size",  "label": "Tamaño fuente",     "min": 10, "max": 18, "step": 1, "unit": "px", "default": 13 },
    { "type": "range", "id": "ann_speed", "label": "Segundos por mensaje", "min": 2, "max": 10, "step": 1, "unit": "s", "default": 4 }
  ],
  "presets": [{ "name": "Barra de Anuncios", "category": "Content" }]
}
{% endschema %}
