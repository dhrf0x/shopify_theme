{%- comment -%}
  Barra de Anuncios v6.0 — WF Urban Muscle
  Live site: carrusel CSS puro con @keyframes
  Editor Shopify: JS detecta Shopify.designMode y muestra slides estáticos
  Subir a: sections/announcement-bar.liquid
{%- endcomment -%}

{%- comment -%}── Visibilidad ──{%- endcomment -%}
{%- assign _vis     = section.settings.ann_visibility | default: 'all' -%}
{%- assign _enabled = section.settings.ann_enabled -%}
{%- assign _show    = false -%}
{%- if _vis == 'all' or _vis == blank or _vis == nil -%}{%- assign _show = true -%}
{%- elsif _vis == 'home' and template == 'index' -%}{%- assign _show = true -%}
{%- elsif _vis == 'not_home' and template != 'index' -%}{%- assign _show = true -%}
{%- endif -%}
{%- if _enabled == false -%}{%- assign _show = false -%}{%- endif -%}

{%- comment -%}── Mensajes ──{%- endcomment -%}
{%- assign _msgs = '' | split: ',' -%}
{%- assign _urls = '' | split: ',' -%}
{%- if section.settings.ann_msg1 != blank -%}
  {%- assign _msgs = _msgs | push: section.settings.ann_msg1 -%}
  {%- assign _urls = _urls | push: section.settings.ann_link1 -%}
{%- endif -%}
{%- if section.settings.ann_msg2 != blank -%}
  {%- assign _msgs = _msgs | push: section.settings.ann_msg2 -%}
  {%- assign _urls = _urls | push: section.settings.ann_link2 -%}
{%- endif -%}
{%- if section.settings.ann_msg3 != blank -%}
  {%- assign _msgs = _msgs | push: section.settings.ann_msg3 -%}
  {%- assign _urls = _urls | push: section.settings.ann_link3 -%}
{%- endif -%}
{%- assign _total = _msgs.size -%}

{%- if _show -%}
{%- assign _speed = section.settings.ann_speed | default: 4 -%}
{%- assign _bg    = section.settings.ann_bg    | default: '#cc0000' -%}
{%- assign _color = section.settings.ann_color | default: '#ffffff' -%}
{%- assign _size  = section.settings.ann_size  | default: 13 -%}
{%- assign _sid   = section.id -%}
{%- assign _cycle = _total | times: _speed -%}

{%- comment -%} Porcentajes del keyframe por número de mensajes {%- endcomment -%}
{%- if _total <= 1 -%}
  {%- assign _pct_in = 3 -%}{%- assign _pct_hold = 97 -%}{%- assign _pct_out = 100 -%}
{%- elsif _total == 2 -%}
  {%- assign _pct_in = 4 -%}{%- assign _pct_hold = 44 -%}{%- assign _pct_out = 50 -%}
{%- else -%}
  {%- assign _pct_in = 3 -%}{%- assign _pct_hold = 29 -%}{%- assign _pct_out = 33 -%}
{%- endif -%}

<div class="wf-ann" id="wf-ann-{{ _sid }}"
  style="background:{{ _bg }};color:{{ _color }};font-size:{{ _size }}px;">
  <div class="wf-ann__wrap" id="wf-ann-wrap-{{ _sid }}">
    {%- if _total == 0 -%}
      <span class="wf-ann__slide wf-ann__slide--static">{{ section.settings.ann_msg1 | default: '✦ Bienvenido a WF Urban Muscle ✦' }}</span>
    {%- else -%}
      {%- for _m in _msgs -%}
        {%- assign _u = _urls[forloop.index0] -%}
        <span class="wf-ann__slide wf-ann__slide--{{ forloop.index }}">
          {%- if _u != blank -%}<a href="{{ _u }}" style="color:inherit;text-decoration:underline dotted;">{{ _m }}</a>
          {%- else -%}{{ _m }}{%- endif -%}
        </span>
      {%- endfor -%}
    {%- endif -%}
  </div>
</div>

<style>
#wf-ann-{{ _sid }} {
  position: relative;
  width: 100%;
  display: flex;
  align-items: stretch;
  text-align: center;
  font-weight: 600;
  letter-spacing: 0.03em;
  box-sizing: border-box;
  z-index: 10;
  overflow: hidden;
}
#wf-ann-{{ _sid }} .wf-ann__wrap {
  flex: 1;
  position: relative;
  min-height: 38px;
  display: flex;
  align-items: center;
  justify-content: center;
  padding: 8px 16px;
}
/* Todos los slides apilados, invisibles por defecto */
#wf-ann-{{ _sid }} .wf-ann__slide {
  position: absolute;
  inset: 0;
  display: flex;
  align-items: center;
  justify-content: center;
  padding: 0 8px;
  opacity: 0;
}
/* Slide estático (0 mensajes configurados) */
#wf-ann-{{ _sid }} .wf-ann__slide--static {
  opacity: 1;
  position: relative;
}
{%- if _total == 1 -%}
/* Un solo mensaje: siempre visible */
#wf-ann-{{ _sid }} .wf-ann__slide--1 { opacity: 1; position: relative; }
{%- elsif _total > 1 -%}
/* Animación escalonada para el site live */
#wf-ann-{{ _sid }} .wf-ann__slide {
  animation: wfAnn{{ _sid }} {{ _cycle }}s linear infinite;
  animation-fill-mode: backwards;
}
#wf-ann-{{ _sid }} .wf-ann__slide--1 { animation-delay: 0s; }
#wf-ann-{{ _sid }} .wf-ann__slide--2 { animation-delay: {{ _speed }}s; }
{%- if _total >= 3 -%}
#wf-ann-{{ _sid }} .wf-ann__slide--3 { animation-delay: {{ _speed | times: 2 }}s; }
{%- endif -%}

@keyframes wfAnn{{ _sid }} {
  0%               { opacity: 0; transform: translateY(5px); }
  {{ _pct_in }}%   { opacity: 1; transform: translateY(0); }
  {{ _pct_hold }}% { opacity: 1; transform: translateY(0); }
  {{ _pct_out }}%  { opacity: 0; transform: translateY(-5px); }
  {{ _pct_out | plus: 1 }}% { opacity: 0; }
  100%             { opacity: 0; }
}
{%- endif -%}

/* ── Editor: cuando is-editor está activo, desactivar animación y mostrar todos estáticos ── */
#wf-ann-{{ _sid }}.is-editor .wf-ann__slide {
  animation: none !important;
  opacity: 1 !important;
  position: relative !important;
}
/* En el editor mostrar slides en fila (apilados verticalmente para no solapar) */
#wf-ann-{{ _sid }}.is-editor .wf-ann__wrap {
  flex-direction: column;
  gap: 2px;
  padding: 6px 16px;
}
</style>

<script>
(function() {
  var sid  = '{{ _sid }}';
  var bar  = document.getElementById('wf-ann-' + sid);
  if (!bar) return;

  // Si estamos en el editor de Shopify, desactivar animación CSS
  // y mostrar todos los slides visibles para que el usuario pueda previsualizar
  if (window.Shopify && window.Shopify.designMode) {
    bar.classList.add('is-editor');
  }

  // Reiniciar al cambiar settings en el editor
  document.addEventListener('shopify:section:load', function(e) {
    if (!e.detail || e.detail.sectionId !== sid) return;
    var b = document.getElementById('wf-ann-' + sid);
    if (!b) return;
    if (window.Shopify && window.Shopify.designMode) {
      b.classList.add('is-editor');
    }
  });
})();
</script>

{%- endif -%}

{% schema %}
{
  "name": "Barra de Anuncios",
  "settings": [
    { "type": "header", "content": "— Activación —" },
    { "type": "checkbox", "id": "ann_enabled", "label": "Activar barra", "default": true },
    {
      "type": "select", "id": "ann_visibility", "label": "Mostrar en", "default": "all",
      "options": [
        { "value": "all",      "label": "Todas las páginas" },
        { "value": "home",     "label": "Solo inicio" },
        { "value": "not_home", "label": "Todas excepto inicio" }
      ]
    },
    { "type": "header", "content": "— Mensajes (hasta 3) —" },
    { "type": "text", "id": "ann_msg1", "label": "Mensaje 1", "default": "✦ Envío gratis en pedidos mayores a $999 ✦" },
    { "type": "url",  "id": "ann_link1", "label": "Enlace 1 (opcional)" },
    { "type": "text", "id": "ann_msg2", "label": "Mensaje 2" },
    { "type": "url",  "id": "ann_link2", "label": "Enlace 2 (opcional)" },
    { "type": "text", "id": "ann_msg3", "label": "Mensaje 3" },
    { "type": "url",  "id": "ann_link3", "label": "Enlace 3 (opcional)" },
    { "type": "header", "content": "— Estilo —" },
    { "type": "color", "id": "ann_bg",    "label": "Fondo",  "default": "#cc0000" },
    { "type": "color", "id": "ann_color", "label": "Texto",  "default": "#ffffff" },
    { "type": "range", "id": "ann_size",  "label": "Tamaño fuente",        "min": 10, "max": 18, "step": 1, "unit": "px", "default": 13 },
    { "type": "range", "id": "ann_speed", "label": "Segundos por mensaje", "min": 2,  "max": 10, "step": 1, "unit": "s",  "default": 4  }
  ],
  "presets": [{ "name": "Barra de Anuncios", "category": "Content" }]
}
{% endschema %}
