{%- comment -%}
  Barra de Anuncios v7.0 — WF Urban Muscle
  Ticker horizontal estilo Gymshark — scroll continuo CSS, sin opacity toggling
  Subir a: sections/announcement-bar.liquid
{%- endcomment -%}

{%- assign _vis     = section.settings.ann_visibility | default: 'all' -%}
{%- assign _enabled = section.settings.ann_enabled -%}
{%- assign _show    = false -%}
{%- if _vis == 'all' or _vis == blank or _vis == nil -%}{%- assign _show = true -%}
{%- elsif _vis == 'home' and template == 'index' -%}{%- assign _show = true -%}
{%- elsif _vis == 'not_home' and template != 'index' -%}{%- assign _show = true -%}
{%- endif -%}
{%- if _enabled == false -%}{%- assign _show = false -%}{%- endif -%}

{%- assign _msgs = '' | split: ',' -%}
{%- assign _urls = '' | split: ',' -%}
{%- if section.settings.ann_msg1 != blank -%}
  {%- assign _msgs = _msgs | push: section.settings.ann_msg1 -%}
  {%- assign _urls = _urls | push: section.settings.ann_link1 -%}
{%- endif -%}
{%- if section.settings.ann_msg2 != blank -%}
  {%- assign _msgs = _msgs | push: section.settings.ann_msg2 -%}
  {%- assign _urls = _urls | push: section.settings.ann_link2 -%}
{%- endif -%}
{%- if section.settings.ann_msg3 != blank -%}
  {%- assign _msgs = _msgs | push: section.settings.ann_msg3 -%}
  {%- assign _urls = _urls | push: section.settings.ann_link3 -%}
{%- endif -%}
{%- assign _total = _msgs.size -%}
{%- if _total == 0 -%}
  {%- assign _msgs = _msgs | push: section.settings.ann_msg1 | default: '✦ Bienvenido a WF Urban Muscle ✦' -%}
  {%- assign _total = 1 -%}
{%- endif -%}

{%- if _show -%}
{%- assign _speed = section.settings.ann_speed | default: 4 -%}
{%- assign _bg    = section.settings.ann_bg    | default: '#cc0000' -%}
{%- assign _color = section.settings.ann_color | default: '#ffffff' -%}
{%- assign _size  = section.settings.ann_size  | default: 13 -%}
{%- assign _sid   = section.id -%}

{%- comment -%}
  Separador entre mensajes en el ticker
  Velocidad del ticker: _total * _speed segundos para recorrer una copia completa
  Duplicamos los mensajes para seamless loop
{%- endcomment -%}
{%- assign _ticker_speed = _total | times: _speed -%}

<div class="wf-ann wf-ann--{{ _sid }}"
     style="background:{{ _bg }};color:{{ _color }};font-size:{{ _size }}px;"
     data-total="{{ _total }}"
     data-single="{% if _total == 1 %}true{% else %}false{% endif %}">

  <div class="wf-ann__viewport">
    {%- comment -%} Si solo hay 1 mensaje: centrado estático, sin scroll {%- endcomment -%}
    {%- if _total == 1 -%}
      <div class="wf-ann__static">
        {%- assign _u = _urls[0] -%}
        {%- if _u != blank -%}
          <a href="{{ _u }}" style="color:inherit;text-decoration:underline dotted;">{{ _msgs[0] }}</a>
        {%- else -%}{{ _msgs[0] }}{%- endif -%}
      </div>
    {%- else -%}
      {%- comment -%} Ticker: track duplicado para loop continuo {%- endcomment -%}
      <div class="wf-ann__track" id="wf-ann-track-{{ _sid }}" aria-live="polite">
        {%- comment -%} Primera copia {%- endcomment -%}
        {%- for _m in _msgs -%}
          {%- assign _u = _urls[forloop.index0] -%}
          <span class="wf-ann__item">
            <span class="wf-ann__dot" aria-hidden="true">✦</span>
            {%- if _u != blank -%}
              <a href="{{ _u }}" style="color:inherit;text-decoration:underline dotted;">{{ _m }}</a>
            {%- else -%}{{ _m }}{%- endif -%}
          </span>
        {%- endfor -%}
        {%- comment -%} Segunda copia (clon para seamless loop) {%- endcomment -%}
        {%- for _m in _msgs -%}
          {%- assign _u = _urls[forloop.index0] -%}
          <span class="wf-ann__item" aria-hidden="true">
            <span class="wf-ann__dot">✦</span>
            {%- if _u != blank -%}
              <a href="{{ _u }}" style="color:inherit;text-decoration:underline dotted;">{{ _m }}</a>
            {%- else -%}{{ _m }}{%- endif -%}
          </span>
        {%- endfor -%}
      </div>
    {%- endif -%}
  </div>

</div>

<style>
/* ── Barra ── */
.wf-ann--{{ _sid }} {
  width: 100%;
  min-height: 38px;
  display: flex;
  align-items: center;
  box-sizing: border-box;
  z-index: 10;
  overflow: hidden;
  position: relative;
}

/* ── Viewport: contiene el track, overflow oculto ── */
.wf-ann--{{ _sid }} .wf-ann__viewport {
  flex: 1;
  overflow: hidden;
  display: flex;
  align-items: center;
  height: 38px;
  -webkit-mask-image: linear-gradient(to right, transparent 0%, black 5%, black 95%, transparent 100%);
  mask-image: linear-gradient(to right, transparent 0%, black 5%, black 95%, transparent 100%);
}

/* ── 1 mensaje: centrado estático ── */
.wf-ann--{{ _sid }} .wf-ann__static {
  width: 100%;
  text-align: center;
  padding: 0 16px;
  font-weight: 600;
  letter-spacing: 0.05em;
}

/* ── Track: fila de mensajes, scroll continuo ── */
.wf-ann--{{ _sid }} .wf-ann__track {
  display: flex;
  align-items: center;
  white-space: nowrap;
  will-change: transform;
  animation: wfTicker{{ _sid }} {{ _ticker_speed }}s linear infinite;
}

/* Pausa on hover */
.wf-ann--{{ _sid }}:hover .wf-ann__track {
  animation-play-state: paused;
}

.wf-ann--{{ _sid }} .wf-ann__item {
  display: inline-flex;
  align-items: center;
  gap: 0.5em;
  padding: 0 2.5em;
  font-weight: 600;
  letter-spacing: 0.05em;
}

.wf-ann--{{ _sid }} .wf-ann__dot {
  font-size: 0.7em;
  opacity: 0.7;
}

/* ── Keyframe: translate -50% = una copia completa (loop perfecto) ── */
@keyframes wfTicker{{ _sid }} {
  0%   { transform: translateX(0); }
  100% { transform: translateX(-50%); }
}

/* ── Editor Shopify: mostrar todos estáticos ── */
.wf-ann--{{ _sid }}.is-editor .wf-ann__track {
  animation: none !important;
  flex-wrap: wrap;
  white-space: normal;
}
.wf-ann--{{ _sid }}.is-editor .wf-ann__item {
  padding: 4px 12px;
}
.wf-ann--{{ _sid }}.is-editor .wf-ann__viewport {
  -webkit-mask-image: none;
  mask-image: none;
  height: auto;
  flex-wrap: wrap;
}
</style>

<script>
(function() {
  var bar = document.querySelector('.wf-ann--{{ _sid }}');
  if (!bar) return;
  if (window.Shopify && window.Shopify.designMode) {
    bar.classList.add('is-editor');
  }
  document.addEventListener('shopify:section:load', function(e) {
    if (e.detail && e.detail.sectionId === '{{ _sid }}') {
      var b = document.querySelector('.wf-ann--{{ _sid }}');
      if (b && window.Shopify && window.Shopify.designMode) b.classList.add('is-editor');
    }
  });
})();
</script>

{%- endif -%}

{% schema %}
{
  "name": "Barra de Anuncios",
  "settings": [
    { "type": "header", "content": "— Activación —" },
    { "type": "checkbox", "id": "ann_enabled", "label": "Activar barra", "default": true },
    {
      "type": "select", "id": "ann_visibility", "label": "Mostrar en", "default": "all",
      "options": [
        { "value": "all",      "label": "Todas las páginas" },
        { "value": "home",     "label": "Solo inicio" },
        { "value": "not_home", "label": "Todas excepto inicio" }
      ]
    },
    { "type": "header", "content": "— Mensajes (hasta 3) —" },
    { "type": "text", "id": "ann_msg1", "label": "Mensaje 1", "default": "✦ Envío gratis en pedidos mayores a $999 ✦" },
    { "type": "url",  "id": "ann_link1", "label": "Enlace 1 (opcional)" },
    { "type": "text", "id": "ann_msg2", "label": "Mensaje 2" },
    { "type": "url",  "id": "ann_link2", "label": "Enlace 2 (opcional)" },
    { "type": "text", "id": "ann_msg3", "label": "Mensaje 3" },
    { "type": "url",  "id": "ann_link3", "label": "Enlace 3 (opcional)" },
    { "type": "header", "content": "— Estilo —" },
    { "type": "color", "id": "ann_bg",    "label": "Fondo",  "default": "#cc0000" },
    { "type": "color", "id": "ann_color", "label": "Texto",  "default": "#ffffff" },
    { "type": "range", "id": "ann_size",  "label": "Tamaño fuente",        "min": 10, "max": 18, "step": 1, "unit": "px", "default": 13 },
    { "type": "range", "id": "ann_speed", "label": "Velocidad (seg/mensaje)", "min": 3, "max": 15, "step": 1, "unit": "s", "default": 5 }
  ],
  "presets": [{ "name": "Barra de Anuncios", "category": "Content" }]
}
{% endschema %}
