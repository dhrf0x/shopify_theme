{%- comment -%}
  Barra de Anuncios v9.0 — WF Urban Muscle
  Crossfade centrado — un mensaje a la vez con fade suave
  Usa BLOCKS nativos de Shopify
  Subir a: sections/announcement-bar.liquid
{%- endcomment -%}

{%- assign _vis     = section.settings.ann_visibility | default: 'all' -%}
{%- assign _enabled = section.settings.show_bar -%}
{%- assign _show    = false -%}
{%- if _vis == 'all' or _vis == blank or _vis == nil -%}{%- assign _show = true -%}
{%- elsif _vis == 'home' and template == 'index' -%}{%- assign _show = true -%}
{%- elsif _vis == 'not_home' and template != 'index' -%}{%- assign _show = true -%}
{%- endif -%}
{%- if _enabled == false -%}{%- assign _show = false -%}{%- endif -%}

{%- comment -%} Contar bloques con texto ─────────────────────────── {%- endcomment -%}
{%- assign _active = 0 -%}
{%- for block in section.blocks -%}
  {%- if block.settings.text != blank -%}{%- assign _active = _active | plus: 1 -%}{%- endif -%}
{%- endfor -%}

{%- if _show and _active > 0 -%}
{%- assign _sid   = section.id -%}
{%- assign _bg    = section.settings.background_color | default: '#cc0000' -%}
{%- assign _color = section.settings.text_color       | default: '#ffffff' -%}
{%- assign _size  = section.settings.font_size        | default: 13 -%}
{%- assign _speed = section.settings.slide_speed      | default: 5 -%}

<div class="wf-ann" id="wf-ann-{{ _sid }}"
  style="background:{{ _bg }};color:{{ _color }};font-size:{{ _size }}px;"
  data-speed="{{ _speed }}">

  {%- comment -%} Todos los slides apilados, JS controla cuál es visible ─ {%- endcomment -%}
  <div class="wf-ann__stage">
    {%- assign _first = true -%}
    {%- for block in section.blocks -%}
      {%- assign msg = block.settings.text | strip -%}
      {%- if msg != blank -%}
        <span class="wf-ann__slide{% if _first %} is-active{% endif %}"
              {{ block.shopify_attributes }}>
          {%- if block.settings.link != blank -%}
            <a href="{{ block.settings.link }}" style="color:inherit;text-decoration:underline dotted;">{{ msg }}</a>
          {%- else -%}{{ msg }}{%- endif -%}
        </span>
        {%- assign _first = false -%}
      {%- endif -%}
    {%- endfor -%}
  </div>

</div>

<style>
/* ── Contenedor ── */
#wf-ann-{{ _sid }} {
  position: relative;
  width: 100%;
  min-height: 38px;
  display: flex;
  align-items: center;
  justify-content: center;
  box-sizing: border-box;
  z-index: 10;
  font-weight: 600;
  letter-spacing: 0.05em;
  text-align: center;
  overflow: hidden;
}

/* ── Stage: área centrada con altura fija ── */
#wf-ann-{{ _sid }} .wf-ann__stage {
  position: relative;
  width: 100%;
  height: 38px;
  display: flex;
  align-items: center;
  justify-content: center;
}

/* ── Slides: apilados, invisibles por defecto ── */
#wf-ann-{{ _sid }} .wf-ann__slide {
  position: absolute;
  inset: 0;
  display: flex;
  align-items: center;
  justify-content: center;
  padding: 0 20px;
  opacity: 0;
  transition: opacity 0.6s ease;
  pointer-events: none;
}

/* ── Slide activo ── */
#wf-ann-{{ _sid }} .wf-ann__slide.is-active {
  opacity: 1;
  pointer-events: auto;
}
</style>

<script>
(function() {
  var bar    = document.getElementById('wf-ann-{{ _sid }}');
  if (!bar) return;

  var slides = bar.querySelectorAll('.wf-ann__slide');
  if (slides.length < 2) return; /* 1 slide: el CSS ya lo muestra con is-active */

  var total   = slides.length;
  var current = 0;
  var speed   = parseInt(bar.getAttribute('data-speed'), 10) * 1000 || 5000;

  function next() {
    slides[current].classList.remove('is-active');
    current = (current + 1) % total;
    slides[current].classList.add('is-active');
  }

  var timer = setInterval(next, speed);

  /* Reiniciar si Shopify recarga la sección (editor) */
  document.addEventListener('shopify:section:load', function(e) {
    if (!e.detail || e.detail.sectionId !== '{{ _sid }}') return;
    clearInterval(timer);
    var b = document.getElementById('wf-ann-{{ _sid }}');
    if (!b) return;
    slides  = b.querySelectorAll('.wf-ann__slide');
    total   = slides.length;
    current = 0;
    slides.forEach(function(s, i) {
      s.classList.toggle('is-active', i === 0);
    });
    if (total > 1) timer = setInterval(next, speed);
  });
})();
</script>

{%- endif -%}

{% schema %}
{
  "name": "Barra de Anuncios",
  "max_blocks": 5,
  "settings": [
    { "type": "header", "content": "— Activación —" },
    { "type": "checkbox", "id": "show_bar", "label": "Activar barra", "default": true },
    {
      "type": "select", "id": "ann_visibility", "label": "Mostrar en", "default": "all",
      "options": [
        { "value": "all",      "label": "Todas las páginas" },
        { "value": "home",     "label": "Solo inicio" },
        { "value": "not_home", "label": "Todas excepto inicio" }
      ]
    },
    { "type": "header", "content": "— Estilo —" },
    { "type": "color", "id": "background_color", "label": "Fondo",  "default": "#cc0000" },
    { "type": "color", "id": "text_color",        "label": "Texto",  "default": "#ffffff" },
    {
      "type": "range", "id": "font_size",
      "label": "Tamaño fuente", "min": 10, "max": 18, "step": 1, "unit": "px", "default": 13
    },
    {
      "type": "range", "id": "slide_speed",
      "label": "Segundos por mensaje", "min": 2, "max": 10, "step": 1, "unit": "s", "default": 5
    }
  ],
  "blocks": [
    {
      "type": "message",
      "name": "Anuncio",
      "settings": [
        { "type": "text", "id": "text",  "label": "Mensaje", "default": "✦ Envío gratis en pedidos mayores a $999" },
        { "type": "url",  "id": "link",  "label": "Enlace (opcional)" }
      ]
    }
  ],
  "presets": [
    {
      "name": "Barra de Anuncios",
      "blocks": [
        { "type": "message", "settings": { "text": "✦ Envío gratis en pedidos mayores a $999" } },
        { "type": "message", "settings": { "text": "✦ Nuevos drops disponibles" } },
        { "type": "message", "settings": { "text": "✦ Usa el cupón WFURBAN10 en tu primer compra" } }
      ]
    }
  ]
}
{% endschema %}
