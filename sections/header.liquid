{% if template contains 'index' and settings.header_overlay_home %}
  {% assign header_overlay = 'header-overlay' %}
{% elsif template contains 'collection' and settings.header_overlay_collection %}
  {% assign header_overlay = 'header-overlay' %}
{% elsif template contains 'blog' and settings.header_overlay_blogs %}
 {% assign header_overlay = 'header-overlay' %}
{% elsif template contains 'article' and settings.header_overlay_blogs %}
  {% assign header_overlay = 'header-overlay' %}
{% elsif template contains 'page' and settings.header_overlay_page %}
 {% assign header_overlay = 'header-overlay' %}
{% endif %}

{% assign logo_id = 'logo.png' %}
{% if header_overlay != blank %}
  {% assign logo_id = 'logo-white.png' %}
{% endif %}

{% comment %} ── Announcement Bar integrada en header (renderiza en TODAS las páginas) ── {% endcomment %}
{% assign wf_show_ann = false %}
{% if section.settings.ann_enabled %}
  {% if section.settings.ann_visibility == 'all' %}
    {% assign wf_show_ann = true %}
  {% elsif section.settings.ann_visibility == 'home' and template == 'index' %}
    {% assign wf_show_ann = true %}
  {% elsif section.settings.ann_visibility == 'not_home' and template != 'index' %}
    {% assign wf_show_ann = true %}
  {% endif %}
{% endif %}

{% if wf_show_ann %}
  {% assign ann_messages = '' | split: '' %}
  {% assign ann_links    = '' | split: '' %}
  {% for i in (1..5) %}
    {% assign _mk = 'ann_msg'  | append: i %}
    {% assign _lk = 'ann_link' | append: i %}
    {% assign _mv = section.settings[_mk] %}
    {% if _mv != blank %}
      {% assign ann_messages = ann_messages | push: _mv %}
      {% assign ann_links    = ann_links    | push: section.settings[_lk] %}
    {% endif %}
  {% endfor %}
  {% assign ann_total = ann_messages.size %}

  <div class="wf-ann"
    id="wf-ann-{{ section.id }}"
    style="background:{{ section.settings.ann_bg }};color:{{ section.settings.ann_color }};font-size:{{ section.settings.ann_size }}px;">
    {% if ann_total > 1 %}
      <button class="wf-ann__btn wf-ann__btn--prev" id="wf-ann-prev-{{ section.id }}" aria-label="Anterior">&#8249;</button>
    {% endif %}
    <div class="wf-ann__viewport">
      <div class="wf-ann__track" id="wf-ann-track-{{ section.id }}">
        {% for msg in ann_messages %}
          <div class="wf-ann__slide{% if forloop.first %} is-active{% endif %}">
            {% assign lnk = ann_links[forloop.index0] %}
            {% if lnk != blank %}<a href="{{ lnk }}" style="color:inherit;text-decoration:underline;">{{ msg }}</a>
            {% else %}{{ msg }}{% endif %}
          </div>
        {% endfor %}
      </div>
    </div>
    {% if ann_total > 1 %}
      <button class="wf-ann__btn wf-ann__btn--next" id="wf-ann-next-{{ section.id }}" aria-label="Siguiente">&#8250;</button>
    {% endif %}
  </div>

  <style>
  .wf-ann { position:relative; width:100%; display:flex; align-items:center; padding:0.55rem 2.5rem; font-weight:500; line-height:1.4; overflow:hidden; }
  .wf-ann__viewport { flex:1; overflow:hidden; text-align:center; }
  .wf-ann__track { display:flex; will-change:transform; }
  .wf-ann__slide { flex:0 0 100%; min-width:100%; padding:0 0.5rem; opacity:0; transform:translateY(5px); transition:opacity .35s ease,transform .35s ease; pointer-events:none; }
  .wf-ann__slide.is-active { opacity:1; transform:translateY(0); pointer-events:auto; }
  .wf-ann__btn { background:transparent; border:none; color:inherit; font-size:1.3rem; line-height:1; padding:0 0.5rem; cursor:pointer; opacity:.6; transition:opacity .2s; flex-shrink:0; }
  .wf-ann__btn:hover { opacity:1; }
  </style>

  <script>
  (function(){
    var id = '{{ section.id }}';
    var track = document.getElementById('wf-ann-track-' + id);
    if (!track) return;
    var slides = track.querySelectorAll('.wf-ann__slide');
    var total = slides.length;
    if (total < 2) return;
    var cur = 0;
    var spd = {{ section.settings.ann_speed | times: 1000 }};
    var t;
    function show(n) {
      slides[cur].classList.remove('is-active');
      cur = (n + total) % total;
      slides[cur].classList.add('is-active');
      track.style.transform = 'translateX(-' + (cur * 100) + '%)';
    }
    function start() { t = setInterval(function(){ show(cur + 1); }, spd); }
    function stop()  { clearInterval(t); }
    var pb = document.getElementById('wf-ann-prev-' + id);
    var nb = document.getElementById('wf-ann-next-' + id);
    if (pb) pb.addEventListener('click', function(){ stop(); show(cur - 1); start(); });
    if (nb) nb.addEventListener('click', function(){ stop(); show(cur + 1); start(); });
    start();
  })();
  </script>
{% endif %}

<div class="header-container {{ header_overlay }} js-animate-appear-show" data-section-id="{{ section.id }}" data-section-type="header">
  <header id="main-header">
    <div class="wf-header-inner">

      <!-- ① LEFT: burger (mobile) + nav de género (desktop) -->
      <div class="wf-header__left">
        <!-- Burger solo en mobile/tablet -->
        <div class="burger-container hide-for-large" data-toggle="mobileMenuSidebar">
          <div id="burger">
            <div class="bar topBar"></div>
            <div class="bar btmBar"></div>
          </div>
        </div>

        <!-- Menú de género en desktop -->
        <nav class="wf-gender-nav show-for-large" aria-label="Navegación por género">

          {% comment %} ── HOMBRES — siempre visible si hay label configurado ── {% endcomment %}
          {% assign men_label = section.settings.label_hombres | default: 'Hombres' %}
          {% assign men_href  = section.settings.link_hombres  | default: '/collections' %}
          {% assign men_menu  = section.settings.menu_hombres %}
          {% assign men_links = linklists[men_menu].links %}
          <div class="wf-gender-nav__item{% if men_links.size > 0 %} wf-gender-nav__item--has-dropdown{% endif %}">
            <a href="{{ men_href }}" class="wf-gender-nav__link">
              {{ men_label }}{% if men_links.size > 0 %}<span class="wf-gender-nav__chevron">▾</span>{% endif %}
            </a>
            {% if men_links.size > 0 %}
              <div class="wf-gender-nav__dropdown">
                {% for link in men_links %}
                  <a href="{{ link.url }}" class="wf-gender-nav__dropdown-link">{{ link.title }}</a>
                {% endfor %}
              </div>
            {% endif %}
          </div>

          {% comment %} ── MUJERES — siempre visible si hay label configurado ── {% endcomment %}
          {% assign women_label = section.settings.label_mujeres | default: 'Mujeres' %}
          {% assign women_href  = section.settings.link_mujeres  | default: '/collections' %}
          {% assign women_menu  = section.settings.menu_mujeres %}
          {% assign women_links = linklists[women_menu].links %}
          <div class="wf-gender-nav__item{% if women_links.size > 0 %} wf-gender-nav__item--has-dropdown{% endif %}">
            <a href="{{ women_href }}" class="wf-gender-nav__link">
              {{ women_label }}{% if women_links.size > 0 %}<span class="wf-gender-nav__chevron">▾</span>{% endif %}
            </a>
            {% if women_links.size > 0 %}
              <div class="wf-gender-nav__dropdown">
                {% for link in women_links %}
                  <a href="{{ link.url }}" class="wf-gender-nav__dropdown-link">{{ link.title }}</a>
                {% endfor %}
              </div>
            {% endif %}
          </div>

          {% comment %} ── MENÚ PRINCIPAL adicional ── {% endcomment %}
          {% assign main_menu_id = section.settings.main_menu %}
          {% if main_menu_id != blank %}
            {% for link in linklists[main_menu_id].links %}
              {% assign child_list_handle = link.title | handleize %}
              {% if linklists[child_list_handle].links != blank %}
                <div class="wf-gender-nav__item wf-gender-nav__item--has-dropdown">
                  <a href="{{ link.url }}" class="wf-gender-nav__link">
                    {{ link.title }}<span class="wf-gender-nav__chevron">▾</span>
                  </a>
                  <div class="wf-gender-nav__dropdown">
                    {% for childlink in linklists[child_list_handle].links %}
                      <a href="{{ childlink.url }}" class="wf-gender-nav__dropdown-link">{{ childlink.title | escape }}</a>
                    {% endfor %}
                  </div>
                </div>
              {% else %}
                <div class="wf-gender-nav__item">
                  <a href="{{ link.url }}" class="wf-gender-nav__link">{{ link.title }}</a>
                </div>
              {% endif %}
            {% endfor %}
          {% endif %}

        </nav>
      </div>

      <!-- ② CENTER: Logo -->
      <div class="wf-header__center">
        <div class="logo-wrap">
          {% if settings.logo_use_image %}
            {% if template.name == 'index' %}
              <h1 itemscope itemtype="http://schema.org/Organization" class="header__title_img">
                <a href="/" itemprop="url" class="logo__link">
                  <img width="{{ settings.logo_max_width }}" class="logo__img" src="{{ logo_id | asset_url }}" alt="{{ shop.name }}" itemprop="logo">
                </a>
              </h1>
            {% else %}
              <div itemscope itemtype="http://schema.org/Organization">
                <a href="/" itemprop="url" class="logo__link">
                  <img width="{{ settings.logo_max_width }}" class="logo__img" src="{{ logo_id | asset_url }}" alt="{{ shop.name }}" itemprop="logo">
                </a>
              </div>
            {% endif %}
          {% else %}
            <h1 class="header__title" itemscope itemtype="http://schema.org/Organization">
              <a href="/" itemprop="url">{{ shop.name }}</a>
            </h1>
          {% endif %}
        </div>
      </div>

      <!-- ③ RIGHT: iconos -->
      <div class="wf-header__right">
        <ul id="header-right-menu" class="menu">
          {% if section.settings.header_show_search %}
            <li class="menu-item menu-item_search show-for-large">
              <button class="header__search-toggle" id="wf-search-toggle" aria-label="Buscar" aria-expanded="false">
                <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="11" cy="11" r="8"/><line x1="21" y1="21" x2="16.65" y2="16.65"/></svg>
              </button>
            </li>
          {% endif %}

          {% if shop.customer_accounts_enabled and settings.account_link %}
          <li class="menu-item menu-item_user show-for-large">
            <a class="menu-item-link header__account-link" href="{% if customer %}/account{% else %}/account/login{% endif %}">
              <svg id="user-icon" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 64 64"><g><path d="M31.91,34.54a14,14,0,1,0-14-14A14,14,0,0,0,31.91,34.54Z"/><path d="M9.46,57.46H54.54a1.7,1.7,0,0,0,1.71-1.71A16.31,16.31,0,0,0,40,39.46H24A16.31,16.31,0,0,0,7.75,55.75,1.7,1.7,0,0,0,9.46,57.46Z"/></g></svg>
            </a>
          </li>
          {% endif %}

          <li class="menu-item menu-item_cart header__cart" {% if settings.ajax_cart_method == "drawer" %}data-toggle="cartSidebar"{% endif %}>
            <a class="menu-item-link" {% if settings.ajax_cart_method != "drawer" %}href="/cart"{% endif %}>
              <svg id="cart-icon" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 64 64"><path d="M55.06,38.32a2,2,0,0,0,1.77-1.64l3.77-21.17a2,2,0,0,0-1.88-2.35L12.12,11,6.63,6.46A2,2,0,1,0,4.09,9.54l5.53,4.55,7.81,25.52-2.59,4.93A3.55,3.55,0,0,0,18,49.74h2.71a4.64,4.64,0,1,0,5.74,0H46a4.64,4.64,0,1,0,5.74,0h4.68a2,2,0,0,0,0-4H18.73l2.13-4Z"/></svg>
              <div class="header__cart-count {% if cart.item_count == 0 %}hidden-count{% endif %}">
                <span id="CartCount">{{ cart.item_count }}</span>
              </div>
              <span class="visually-hidden">{{ 'layout.cart.title' | t | upcase }}
                <span id="CartCost">{{ cart.total_price | money }}</span>
              </span>
            </a>
          </li>
        </ul>
      </div>

    </div>
  </header>
</div>

<script>
// Scroll-aware header
(function() {
  var header = document.querySelector('.header-container');
  if (!header) return;
  var threshold = 60;
  function onScroll() {
    if (window.scrollY > threshold) {
      header.classList.add('is-scrolled');
    } else {
      header.classList.remove('is-scrolled');
    }
  }
  window.addEventListener('scroll', onScroll, { passive: true });
  onScroll();
})();
</script>


{% if section.settings.header_show_search %}
<!-- ══ WF Search Modal — tiempo real ══ -->
<div id="wf-search-modal" class="wf-modal" role="dialog" aria-modal="true" aria-label="Buscar productos" aria-hidden="true">
  <div class="wf-modal__backdrop" id="wf-modal-backdrop"></div>
  <div class="wf-modal__box">
    <!-- Cabecera del modal -->
    <div class="wf-modal__header">
      <span class="wf-modal__icon">
        <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="11" cy="11" r="8"/><line x1="21" y1="21" x2="16.65" y2="16.65"/></svg>
      </span>
      <input
        type="search"
        id="wf-search-input"
        class="wf-modal__input"
        placeholder="Buscar productos..."
        autocomplete="off"
        autocorrect="off"
        spellcheck="false"
        aria-label="Buscar productos">
      <button class="wf-modal__close" id="wf-search-close" aria-label="Cerrar">
        <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round"><line x1="18" y1="6" x2="6" y2="18"/><line x1="6" y1="6" x2="18" y2="18"/></svg>
        <span>ESC</span>
      </button>
    </div>
    <!-- Resultados en tiempo real -->
    <div class="wf-modal__results" id="wf-search-results" aria-live="polite">
      <div class="wf-modal__empty" id="wf-search-empty" style="display:none">
        <p>Sin resultados para <strong id="wf-search-empty-term"></strong></p>
      </div>
      <div class="wf-modal__grid" id="wf-search-grid"></div>
      <a class="wf-modal__see-all" id="wf-search-see-all" href="#" style="display:none">
        Ver todos los resultados →
      </a>
    </div>
    <div class="wf-modal__hint">
      Presiona <kbd>ESC</kbd> para cerrar · <kbd>Enter</kbd> para buscar todo
    </div>
  </div>
</div>

<script>
(function() {
  var DEBOUNCE_MS = 280;
  var MAX_RESULTS = 6;
  var timer = null;
  var lastQuery = '';

  function $(id) { return document.getElementById(id); }

  function openModal() {
    var modal = $('wf-search-modal');
    if (!modal) return;
    modal.classList.add('is-open');
    modal.setAttribute('aria-hidden', 'false');
    document.body.classList.add('wf-modal-open');
    setTimeout(function() {
      var inp = $('wf-search-input');
      if (inp) inp.focus();
    }, 60);
  }

  function closeModal() {
    var modal = $('wf-search-modal');
    if (!modal) return;
    modal.classList.remove('is-open');
    modal.setAttribute('aria-hidden', 'true');
    document.body.classList.remove('wf-modal-open');
    var inp = $('wf-search-input');
    if (inp) inp.value = '';
    clearResults();
  }

  function clearResults() {
    var grid  = $('wf-search-grid');
    var empty = $('wf-search-empty');
    var seeAll = $('wf-search-see-all');
    if (grid)   grid.innerHTML = '';
    if (empty)  empty.style.display = 'none';
    if (seeAll) seeAll.style.display = 'none';
  }

  function showLoading() {
    var grid = $('wf-search-grid');
    if (grid) grid.innerHTML = '<div class="wf-modal__loading"><span></span><span></span><span></span></div>';
  }

  function moneyFormat(cents) {
    if (!cents) return '';
    return '$' + (cents / 100).toLocaleString('es-MX', { minimumFractionDigits: 0, maximumFractionDigits: 0 });
  }

  function buildCard(product) {
    var img;
    if (product.featured_image && product.featured_image.url) {
      // Asegurar protocolo https
      var rawUrl = product.featured_image.url;
      if (rawUrl.indexOf('//') === 0) rawUrl = 'https:' + rawUrl;
      // Eliminar cualquier size suffix existente (_NNNxNNN)
      rawUrl = rawUrl.replace(/_\d+x\d*(\.(?:jpg|jpeg|png|gif|webp))/i, '$1');
      // Usar Shopify Image Transformation API (?width=) — funciona siempre
      var sep = rawUrl.indexOf('?') !== -1 ? '&' : '?';
      var sized = rawUrl + sep + 'width=320';
      img = '<img src="' + sized + '" alt="' + product.title.replace(/"/g, '&quot;') + '" loading="eager">';
    } else {
      img = '<div class="wf-card__no-img"></div>';
    }
    var price = product.price_min ? ('<span class="wf-card__price">' + moneyFormat(product.price_min) + '</span>') : '';
    var sold = product.available === false ? '<span class="wf-card__badge">Agotado</span>' : '';
    return '<a href="/products/' + product.handle + '" class="wf-card">'
      + '<div class="wf-card__img">' + img + sold + '</div>'
      + '<div class="wf-card__info">'
      + '<p class="wf-card__title">' + product.title + '</p>'
      + price
      + '</div></a>';
  }

  function renderResults(data, query) {
    var grid   = $('wf-search-grid');
    var empty  = $('wf-search-empty');
    var seeAll = $('wf-search-see-all');
    var term   = $('wf-search-empty-term');
    if (!grid) return;

    var products = (data.resources && data.resources.results && data.resources.results.products) || [];

    if (products.length === 0) {
      grid.innerHTML = '';
      if (term) term.textContent = query;
      if (empty) empty.style.display = '';
      if (seeAll) seeAll.style.display = 'none';
      return;
    }

    if (empty) empty.style.display = 'none';
    var html = '';
    var max = Math.min(products.length, MAX_RESULTS);
    for (var i = 0; i < max; i++) {
      html += buildCard(products[i]);
    }
    grid.innerHTML = html;

    if (seeAll) {
      seeAll.href = '/search?type=product&q=' + encodeURIComponent(query);
      seeAll.style.display = products.length > MAX_RESULTS ? '' : '';
      seeAll.style.display = '';
    }
  }

  function doSearch(query) {
    if (!query || query.length < 2) { clearResults(); return; }
    if (query === lastQuery) return;
    lastQuery = query;
    showLoading();
    fetch('/search/suggest.json?q=' + encodeURIComponent(query) + '&resources[type]=product&resources[limit]=' + (MAX_RESULTS + 1) + '&resources[options][unavailable_products]=last')
      .then(function(r) { return r.json(); })
      .then(function(data) { renderResults(data, query); })
      .catch(function() {
        var grid = $('wf-search-grid');
        if (grid) grid.innerHTML = '<p class="wf-modal__error">Error al buscar. Intenta de nuevo.</p>';
      });
  }

  function init() {
    // Event delegation — no se rompe con Foundation re-init
    document.addEventListener('click', function(e) {
      if (e.target.closest('#wf-search-toggle')) { openModal(); return; }
      if (e.target.closest('#wf-search-close'))  { closeModal(); return; }
      if (e.target.id === 'wf-modal-backdrop')    { closeModal(); return; }
      // Navegar a resultados al hacer clic en "Ver todos"
    }, false);

    document.addEventListener('keydown', function(e) {
      if (e.key === 'Escape' || e.keyCode === 27) { closeModal(); }
    });

    document.addEventListener('input', function(e) {
      if (e.target.id !== 'wf-search-input') return;
      var q = e.target.value.trim();
      clearTimeout(timer);
      if (q.length < 2) { clearResults(); lastQuery = ''; return; }
      timer = setTimeout(function() { doSearch(q); }, DEBOUNCE_MS);
    });

    document.addEventListener('keydown', function(e) {
      if (e.target.id !== 'wf-search-input') return;
      if (e.key === 'Enter' && e.target.value.trim()) {
        window.location.href = '/search?type=product&q=' + encodeURIComponent(e.target.value.trim());
      }
    });
  }

  if (document.readyState === 'loading') {
    document.addEventListener('DOMContentLoaded', init);
  } else {
    init();
  }
  document.addEventListener('shopify:section:load', init);
})();
</script>
{% endif %}


{% schema %}
  {
    "name": "Header",
    "settings": [
      { "type": "header",   "content": "Barra de Anuncios" },
      { "type": "checkbox", "id": "ann_enabled",    "label": "Activar barra de anuncios", "default": true },
      { "type": "select",   "id": "ann_visibility", "label": "Mostrar en", "default": "all",
        "options": [
          { "value": "all",      "label": "Todas las páginas"          },
          { "value": "home",     "label": "Solo página principal"      },
          { "value": "not_home", "label": "Todas excepto inicio"       }
        ]
      },
      { "type": "header", "content": "Mensajes (hasta 5)" },
      { "type": "text", "id": "ann_msg1",  "label": "Mensaje 1", "default": "¡Envío gratis en pedidos mayores a $999!" },
      { "type": "url",  "id": "ann_link1", "label": "Enlace 1 (opcional)" },
      { "type": "text", "id": "ann_msg2",  "label": "Mensaje 2" },
      { "type": "url",  "id": "ann_link2", "label": "Enlace 2 (opcional)" },
      { "type": "text", "id": "ann_msg3",  "label": "Mensaje 3" },
      { "type": "url",  "id": "ann_link3", "label": "Enlace 3 (opcional)" },
      { "type": "text", "id": "ann_msg4",  "label": "Mensaje 4" },
      { "type": "url",  "id": "ann_link4", "label": "Enlace 4 (opcional)" },
      { "type": "text", "id": "ann_msg5",  "label": "Mensaje 5" },
      { "type": "url",  "id": "ann_link5", "label": "Enlace 5 (opcional)" },
      { "type": "header", "content": "Estilo de la barra" },
      { "type": "color", "id": "ann_bg",    "label": "Color de fondo", "default": "#cc0000" },
      { "type": "color", "id": "ann_color", "label": "Color de texto",  "default": "#ffffff" },
      { "type": "range", "id": "ann_size",  "min": 10, "max": 18, "step": 1, "unit": "px", "label": "Tamaño de fuente", "default": 13 },
      { "type": "range", "id": "ann_speed", "min": 2, "max": 12, "step": 1, "unit": "s",  "label": "Velocidad carousel", "default": 4 },
      {
        "type": "header",
        "content": "Desktop Header Settings"
      },
      {
        "type": "link_list",
        "id": "main_menu",
        "label": "Choose Main Menu",
        "default": "main-menu"
      },
      {
        "type": "select",
        "id": "main_menu_alignment",
        "label": "Main Menu Alignment",
        "default": "left",
        "options": [
          {
            "value": "left",
            "label": "Left"
          },
          {
            "value": "center",
            "label": "Center"
          },
          {
            "value": "right",
            "label": "Right"
          }
        ]
      },
      {
        "type": "checkbox",
        "id": "header_show_search",
        "label": "Display Search Icon",
        "default": true
      },
      { "type": "header", "content": "Navegación — Hombres" },
      { "type": "text", "id": "label_hombres", "label": "Etiqueta", "default": "Hombres" },
      { "type": "url",  "id": "link_hombres",  "label": "Enlace (sin submenú)" },
      { "type": "link_list", "id": "menu_hombres", "label": "Submenú Hombres",
        "info": "Crea un menú en Shopify > Online Store > Navigation y selecciónalo aquí." },
      { "type": "header", "content": "Navegación — Mujeres" },
      { "type": "text", "id": "label_mujeres", "label": "Etiqueta", "default": "Mujeres" },
      { "type": "url",  "id": "link_mujeres",  "label": "Enlace (sin submenú)" },
      { "type": "link_list", "id": "menu_mujeres", "label": "Submenú Mujeres",
        "info": "Crea un menú en Shopify > Online Store > Navigation y selecciónalo aquí." }
    ]
  }
{% endschema %}
